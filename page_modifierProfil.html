<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Formulaire d'inscription</title>

    <link rel="stylesheet" href="styles/popup.css">

    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="styles/styles.css">
    <!-- Scrollbar Custom CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
    <!-- Font Awesome JS -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>

    <style type="text/css">
        .terms {
            font-size: 14px;
        }
    </style>

</head>

<body onload="javascript:isConnected();back();">
    <div class="wrapper">
        <!-- Page Content  -->
        <div id="container-fluid">
            <nav class="navbar navbar-dark">
                <div class="container-fluid">
                    <div id="Back"> Back </div>

                    <b class="navtxt">Modification du profil</b>
                </div>
            </nav>
        </div>

        <div class="container">
            <center>
                <form class="form">
                    <div id="InfoUser">
                    </div>
                    <!-- Fenêtre Pop Up pour saisir sa date de naissance -->
                    <div id="popup" class="modal">
                        <!-- Contenu de la fenêtre -->
                    </div>
                    <!-- Fin du popUp -->

                    <!-- Photo de profil -->
                    <br><br>
                    <p class="terms">
                        <label for="ma_photo">Uplaodé une photo de profil (tous formats | <b>max. 1 Mo</b>) :</label><br />
                    <input type="file" name="ma_photo" id="ma_photo" /><br /></p>

                    <div id="typeProfil"></div>

                    <div id="AffichageAdhérent">
                    <p class="terms">
                        <label for="mon_fichier">Uploadé un nouveau <b>certificat médical</b> (tous formats | <b>max. 1 Mo</b>) :</label><br />
                        <input type="file" name="mon_fichier" id="mon_fichier" /><br /></p>
                    <p class="terms">En acceptant l'inscription, vous: <br>Autorisez les responsables de Val'Acro á faire pratiquer, en cas d'urgence, une intervention médicale ou chirurgicale en cas de nécessité.<br>Autorisez l'adhérent á venir par ses propres moyens sur le lieu d'entraînement ou de compétition <br>et á être transporté en autocar ou, le cas échéant, par les véhicules des accompagnateurs.
                    </p>
                    <p>
                    <label style="font-size: 12px;" for="conditions"><input type="checkbox" name="accept" id="conditions">  Je valide les conditions</label> <!--Fait par Giovanni --></p>
                    </div>
                    <input type="button" name="submit" id="submit" value="Valider" class="btn btn-dark input"><br><br>
                    <input type="button" name="canceled" id="canceled" value="Annuler" class="btn btn-dark input" onclick="Annuler();"></p>
                </form>
            </center>
            <center>
            <br><br> <p style="font-size: 12px;">* Un profil parent permet de voir les informations de tous les profils associès à ce compte. Un profil parent peut être créé sans qu'il soit adhérent à l'association</p></center>
        </div>


<div id="popupSubmit" class="modal">
    <!-- Contenu de la fenêtre -->
    <div class="modal-content">
        <div id="closeAlertPopUp"></div> <!-- croix pour fermer la pop up-->
        <center>
        <p><div id="message"></div></p>
        </center>
    </div>
</div>

    </div>

    <div class="overlay"></div>
    <!-- jQuery CDN - Slim version (=without AJAX) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="styles/bootstrap/bootstrap.min.js"></script>
    <!-- jQuery Custom Scroller CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#sidebar").mCustomScrollbar({
                theme: "minimal"
            });
            $('#dismiss, .overlay').on('click', function () {
                $('#sidebar').removeClass('active');
                $('.overlay').removeClass('active');
            });
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').addClass('active');
                $('.overlay').addClass('active');
                $('.collapse.in').toggleClass('in');
                $('a[aria-expanded=true]').attr('aria-expanded', 'false');
            });
        });
    </script>
</body>

</html>
    <!--Script permettant l'emploie de ajax et jquery (connexion au serveur)-->
<script src="https://code.jquery.com/jquery-3.1.1.min.js"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript">
$back = null; //Variable qui renvoie vers la page précédente (page source)
    function isConnected() {$.post(
            'http://localhost/JSValAcro/isConnected.php',
            {
                //no data()
            },
            function(data) {
                console.log(data);
                if (data == "Success") {
                    console.log('connected !!!!')
                    loadMyProfil();
                }
                else {
                    //User must be connected
                    console.log("Il y a un pb!!!");
                }
            },
            'text'
        );};

    function adherant() {
        if ($('#adherent').is(":checked") === true) {
            //C'est un nouvel adhérent, on affiche la partie concernant les adhérents
            document.getElementById('AffichageAdhérent').style.display = "block";
        } else {
            //C'est seulement un parent
            document.getElementById('AffichageAdhérent').style.display = "none";
        }
    };

    function extractUrlParams() {
        //On apelle cette fonction seulement si l'utilisateur est connecté! 
        var parms = [];
        var url = location.search.substring(1).split('&');
        //location.search donne la partie de l'url situé après le nom de la page (?....)
        //On exclut le premier caractère de cette partie, qui est ?.
        //On compte le nombre de paramètre passé par la m"thode GET grâce au split('&') où & sépare ces derniers.
        for (var i=0; i<url.length; i++) {
            //url[i] contient un data de type "paramètre=value"
            var idETparam = url[i].split('=');
            parms[idETparam[0]]=idETparam[1];
            //si il apelle la page avec des paramètres mal définit, (ex: ..?id_event&other_parm=2), on retrouve alors un undefined en valeur.
        }
        return parms;
    };

    function back() {
        html = '<a href=';
        $back = "page_myprofile.html";
        html += $back;
        html+=' class="btn btn-dark"><i class="fas fa-arrow-left"></i></a>';
        $('#Back').html(html);
    }
    function Annuler() {
        document.location.href="page_myprofile.html";
    }

</script>

<script type="text/javascript">
    $("#submit").click(function(e){
        console.log(isAdherentInitialment);
        console.log("Submit!");
        if (($('#adherent').is(":checked") === true) && (isAdherentInitialment == false)) {
            console.log('new adherent');
            //C'est un nouvel adhérent, on affiche la partie concernant les adhérents
            if (($('#conditions').is(":checked") === true)) {
                if ($('#mon_fichier').val().length > 0) {
                    console.log('adh!');
                    upload();
                } else {
                    alertPopUp ("Vous devez joindre votre certificat médical");
                }
            }
            else {
                alertPopUp("Veuillez accepeter les conditions générales")
            }
        }
        else if ($('#adherent').is(":checked") === true) {
            //C'était déjà un nouvel adhérent, et on n'est pas obligé de joindre un certificat médical
            if (($('#conditions').is(":checked") === true)) {
                //fonctions!
                upload();
            }
            else {
                alertPopUp("Veuillez accepeter les conditions générales")
            }
        }
        else if ($('#parent').is(":checked") === true){
            //C'est seulement un parent
            upload(); /*autres fonctions*/
        }
        else {
            //Aucun statut n'a été coché, on met un message d'erreur
            alertPopUp('Veuillez définir si vous êtes parent ou/et adhérent');
        }  
        //Pas besoin de vérifier si new adherent ou pas... car fait ci-dessus. faire une fonction upDateProfil qui va uploade file si seulement isset...
    });

    var isAdherentInitialment = null;

    function loadMyProfil() {
        console.log('in loader');
        $.post(
        'http://localhost/JSValAcro/loadProfilWithId.php',
        {
            profil_id : extractUrlParams()['profil_id']
        },
        function(data) {
            console.log(data);
            console.log(data["day"]);
            console.log(extractUrlParams()['profil_id']);
            if (data != null) {
                //Le nom, prenom et date de naissance sont obligatoirement définit
                    html = '<input type="text" name="nom" id="nom" placeholder="Nom" class="text-input text-input--underbar" value="'+ data["nom"] +'"> <br><br><input type="text" name="prenom" id="prenom" placeholder="Prenom" class="text-input text-input--underbar" value="'+data["prenom"]+'"> <br><br><div id="bday">'+ data["day"]+' - '+data["month"]+' - '+data["year"] +'</div><br> <div id="bdayButton" style="cursor : pointer;">Entrer votre date de naissance</div> <br>';
                    if ( ((data['phone_number']) != undefined) || ((data['phone_number']) != null) || (!(typeof data['phone_number']) !== 'number')) {
                        //Un numérode téléphone est déjà saisit
                        html += '<input type="number" id="phoneNumber" placeholder="Numéro de téléphone" value="'+ data["phone_number"]+'">';
                    } else {
                        html += '<input type="number" id="phoneNumber" placeholder="Numéro de téléphone">';
                    }
                    $('#InfoUser').html(html);
                    htmlPopUpBday ='<div class="modal-content"><span class="close" style="text-align: right;">&times;</span> <!-- croix pour fermer la pop up--><center><p> <table><thead><td> Day </td><td> Mounth </td><td> Year </td></thead><tbody><td><input type="number" id="day" min="1" max="31" placeholder="dd" value ="'+data["day"]+'"></td><td><input type="number" id="mounth" min="1" max="12" placeholder="mm" value="'+data["month"]+'"></td><td><input type="number" id="year" min="0" max="9999" placeholder="yyyy" value="'+data["year"]+'"></td></tbody><tfoot><td colspan="2"></td><td colspan="1" style="text-align:center; cursor:pointer;" onclick="setBday(); closePopUp();">Valider</td></tfoot></table> </p></center></div>';
                    $('#popup').html(htmlPopUpBday);
                    // Get the modal
                    modal = document.getElementById('popup');
                    // Get the button that opens the modal
                    btn = document.getElementById("bdayButton");
                    // Get the <span> element that closes the modal
                    span = document.getElementsByClassName("close")[0];
                    // When the user clicks on the button, open the modal 
                    btn.onclick = function() {
                         modal.style.display = "block";
                    };
                        // When the user clicks on <span> (x), close the modal
                    span.onclick = function() {
                        closePopUp();
                    };
                    if (data['profil_parent'] == true) {
                        html2 = '<p><label style="font-size: 12px;" for="parent"><input type="checkbox" name="parent" id="parent" checked="'+true+'"> Ce profil est un profil parent *</label><br>';
                        console.log('adh');
                    }
                    else {
                        html2 = '<p><label style="font-size: 12px;" for="parent"><input type="checkbox" name="parent" id="parent" unchecked="'+true+'"> Ce profil est un profil parent *</label><br>';
                    }
                    if (data['profil_adherent'] == true) {
                        html2+='<label style="font-size: 12px;" for="adherent"><input type="checkbox" name="adherent" id="adherent" checked="'+true+'" onclick="adherant();"> Je suis un nouvel adhérent</label></p>';
                        document.getElementById('AffichageAdhérent').style.display = "block";
                        isAdherentInitialment = true;
                    }
                    else {
                        html2+='<label style="font-size: 12px;" for="adherent"><input type="checkbox" name="adherent" id="adherent" unchecked="'+true+'" onclick="adherant();"> Je suis un nouvel adhérent</label></p>';
                        document.getElementById('AffichageAdhérent').style.display = "none";
                        //Ce n'est pas initialement un adhérent. Si la case adherent est coché lors du submit, il faut absolument un certificat médical!!! Pour vérifier cela, on enregistre l'info
                        isAdherentInitialment = false;

                    }
                    $('#typeProfil').html(html2);
            }

        },
        'json'
    );};

function upload() {
    var certificat = document.querySelector("#mon_fichier");
    var photo = document.querySelector('#ma_photo');
    var res;
    xhr = new XMLHttpRequest();
    xhr.open("POST", "http://localhost/JSValAcro/updateMyProfil.php");
    /*xhr.upload.onprogress = function(e) {
        progress.value = e.loaded;
        progress.max = e.total;
    }*/
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 /*La requête est terminée*/ && (xhr.status == 200 || xhr.status == 0)) {
            //Requête entièrement terminé
            alertPopUp(xhr.responseText);
        }
        else {
            //Do nothing
        }
    }
    var form = new FormData();
    form.append("certificat", certificat.files[0]);
    form.append("photo", photo.files[0]);
    form.append("isParent", $("#parent").is(":checked"));
    form.append("isAdherent", $('#adherent').is(":checked"));
    form.append("nom", $("#nom").val());
    form.append("prenom", $("#prenom").val());
    form.append("bday", $("#day").val());
    form.append("bmonth", $("#mounth").val());
    form.append("byear", $("#year").val());
    form.append("profil_id", extractUrlParams()['profil_id']);
    form.append("phone_number", $("#phoneNumber").val())
    xhr.send(form);
    return true;
};

var alert = document.getElementById('popupSubmit');
//$quit = document.getElementsById("logoCloseAlertPopUp");
function alertPopUp(rep) {
    var html ='';
    if (rep == "Votre profil a été créé avec succés") {
        html = '<a href='+$back+'><span id="logoCloseAlertPopUp" class="close" style="text-align: right;">&times;</span></a>';
    } else {
        html = '<span class="close" style="text-align: right;" onclick="closeAlertPopUp()";>&times;</span>';
    }
    $("#closeAlertPopUp").html(html);
    $("#message").html(rep);
    alert.style.display = "block";
}

function closeAlertPopUp() {
    console.log($("#parent").is(":checked"));
    alert.style.display = "none";
}
</script>

<script>
    //Script permettant de contrôler la fenêtre pop up
    // Get the modal
    /*
    var modal = document.getElementById('popup');
    // Get the button that opens the modal
    var btn = document.getElementById("bdayButton");
    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];
    // When the user clicks on the button, open the modal 
*/
    function closePopUp() {
        modal.style.display = "none";
    };
    function setBday() {
        $("#bday").html(""+$("#day").val()+"-"+$("#mounth").val()+"-"+$("#year").val());
    };
</script>